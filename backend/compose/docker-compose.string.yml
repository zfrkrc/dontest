services:
  # White Profile
  nmap_white:
    image: instrumentisto/nmap
    profiles: [ "white" ]
    command: -sT -F -oX /data/nmap_white.xml ${TARGET_DOMAIN}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  testssl:
    image: drwetter/testssl.sh
    user: root
    profiles: [ "white" ]
    command: --jsonfile /data/testssl.json ${TARGET_DOMAIN}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  dirsearch:
    build:
      context: ..
      dockerfile: services/dirsearch/Dockerfile
    profiles: [ "white" ]
    # -q: quiet mode to avoid log flooding
    command: dirsearch -u ${TARGET_URL} --format=json -o /data/dirsearch.json -q
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  nikto_white:
    build:
      context: ..
      dockerfile: services/nikto/Dockerfile
    profiles: [ "white" ]
    # Nikto with JSON output format
    command: nikto -h ${TARGET_URL} -o /data/nikto_white.json -Format json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  whatweb:
    build:
      context: ..
      dockerfile: services/whatweb/Dockerfile
    profiles: [ "white" ]
    command: whatweb --log-json /data/whatweb.json ${TARGET_URL}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  nuclei_white:
    build:
      context: ..
      dockerfile: services/nuclei/Dockerfile
    profiles: [ "white" ]
    # Focus on non-intrusive tech detection and exposures
    command: nuclei -u ${TARGET_URL} -tags exposures,tech-detect -jsonl -o /data/nuclei_white.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  arjun:
    build:
      context: ..
      dockerfile: services/arjun/Dockerfile
    profiles: [ "white" ]
    # Ensure protocol is present for Arjun
    command: arjun -u ${TARGET_URL} -oJ /data/arjun.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  dalfox:
    build:
      context: ..
      dockerfile: services/dalfox/Dockerfile
    profiles: [ "white" ]
    # Ensure protocol is present for Dalfox
    command: dalfox url ${TARGET_URL} --output /data/dalfox.json --format json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  wafw00f:
    build:
      context: ..
      dockerfile: services/wafw00f/Dockerfile
    profiles: [ "white" ]
    command: wafw00f ${TARGET_URL} -f json -o /data/wafw00f.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  dnsrecon:
    build:
      context: ..
      dockerfile: services/dnsrecon/Dockerfile
    profiles: [ "white" ]
    command: dnsrecon -d ${TARGET_DOMAIN} --json /data/dnsrecon.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  sqlmap:
    build:
      context: ..
      dockerfile: services/sqlmap/Dockerfile
    profiles: [ "white" ]
    command: -u ${TARGET_URL} --batch --crawl=2 --random-agent --answers="crack=N" --output-dir=/data/sqlmap_output
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  commix:
    build:
      context: ..
      dockerfile: services/commix/Dockerfile
    profiles: [ "white" ]
    command: --url ${TARGET_URL} --batch --output-dir=/data
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  gittools:
    build:
      context: ..
      dockerfile: services/gittools/Dockerfile
    profiles: [ "white" ]
    command: ${TARGET_URL}/.git /data/gitdump
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  wapiti:
    build:
      context: ..
      dockerfile: services/wapiti/Dockerfile
    profiles: [ "white" ]
    command: -u ${TARGET_URL} -f json -o /data/wapiti.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  nosqlmap:
    build:
      context: ..
      dockerfile: services/nosqlmap/Dockerfile
    profiles: [ "white" ]
    command: --target ${TARGET_URL} --attack 1
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  gobuster:
    build:
      context: ..
      dockerfile: services/gobuster/Dockerfile
    profiles: [ "white" ]
    command: dir -u ${TARGET_URL} -w /usr/share/wordlists/common.txt -o /data/gobuster.json --no-error -q
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  # w3af:
  #   build:
  #     context: ..
  #     dockerfile: services/w3af/Dockerfile
  #   profiles: [ "white" ]
  #   # W3AF requires a script file - needs additional setup
  #   command: -s /data/w3af_script.w3af
  #   volumes:
  #     - ${HOST_DATA_DIR}:/data
  #   network_mode: bridge

  arachni:
    build:
      context: ..
      dockerfile: services/arachni/Dockerfile
    profiles: [ "white" ]
    command: ${TARGET_URL} --report-save-path=/data/arachni.afr --output-only-positives
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  # Gray Profile
  nmap_gray:
    image: instrumentisto/nmap
    profiles: [ "gray" ]
    command: -sV -sC -oX /data/nmap_gray.xml ${TARGET_DOMAIN}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  wpscan:
    build:
      context: ..
      dockerfile: services/wpscan/Dockerfile
    profiles: [ "gray" ]
    # Simple command since entrypoint is set in Dockerfile
    command: wpscan --url ${TARGET_URL} --format json -o /data/wpscan.json --disable-tls-checks
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  zap:
    build:
      context: ..
      dockerfile: services/zap/Dockerfile
    profiles: [ "gray" ]
    user: root
    # ZAP baseline script expects output in /zap/wrk/ by default when mapped.
    # Using absolute path inside container to be safe.
    command: zap-baseline.py -t ${TARGET_URL} -J /zap/wrk/zap.json
    volumes:
      - ${HOST_DATA_DIR}:/zap/wrk
    network_mode: bridge

  sslyze:
    build:
      context: ..
      dockerfile: services/sslyze/Dockerfile
    profiles: [ "gray" ]
    # Command is now just the arguments, entrypoint is in Dockerfile
    command: sslyze --json_out=/data/sslyze.json ${TARGET_DOMAIN}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  # Black Profile
  nmap_black:
    image: instrumentisto/nmap
    profiles: [ "black" ]
    command: -A -oX /data/nmap_black.xml ${TARGET_DOMAIN}
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  nuclei:
    build:
      context: ..
      dockerfile: services/nuclei/Dockerfile
    profiles: [ "black" ]
    command: nuclei -u ${TARGET_URL} -jsonl -o /data/nuclei.json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  nikto_black:
    build:
      context: ..
      dockerfile: services/nikto/Dockerfile
    profiles: [ "black" ]
    command: nikto -h ${TARGET_URL} -o /data/nikto_black.json -Format json
    volumes:
      - ${HOST_DATA_DIR}:/data
    network_mode: bridge

  # Merge Service (Alpine based, no build needed)
  merge:
    image: alpine
    container_name: pentaas_merge
    profiles: [ "aux" ] # Prevent running during 'up --profile gray'
    command:
      - sh
      - -c
      - |
        echo "Scan Summary for ${TARGET_URL}" > /app/reports/session/data/scan_summary.txt
        echo "Timestamp: $(date)" >> /app/reports/session/data/scan_summary.txt
        echo "Files found:" >> /app/reports/session/data/scan_summary.txt
        ls -1 /app/reports/session/data >> /app/reports/session/data/scan_summary.txt
    volumes:
      - ${HOST_DATA_DIR}:/app/reports/session/data
    environment:
      - TARGET_URL=${TARGET_URL}
    network_mode: bridge
